<!DOCTYPE html>
<html>
<head>
    <title>Checkout - High Street</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-left">
    <h1 class="logo">
      <a href="index.html">HIGH&nbsp;STREET</a>
    </h1>
  </div>

  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="men.html">Men</a>
    <a href="women.html">Women</a>
    <a href="cart.html">Cart</a>
  </nav>

  <div class="header-icons">
    <a href="cart.html">üõí</a>
  </div>
</header>

<hr>

<h2 class="section-title">Checkout</h2>

<div class="form-container">
  <div class="login-form" id="checkoutBox">
    <p>Loading checkout...</p>
  </div>
</div>

<hr>

<p class="copyright">
  ¬©Ô∏è 2025 High Street. All Rights Reserved.
</p>

<!-- SUPABASE LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<!-- CHECKOUT SCRIPT -->
<script>
/* ============ SUPABASE CONFIG ============ */
const SUPABASE_URL = "https://lnjkpbpizjrpuhwmbqkd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuamtwYnBpempycHVod21icWtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQwNTMsImV4cCI6MjA4MzE5MDA1M30.VSPdTEwoSs4DEreHGwKSHjnDE9qGD-Lp9iLM6V3zMlw";

/* üîë IMPORTANT: different variable name */
const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ============ HELPERS ============ */
function generateOrderId() {
  return "HS-" + Math.floor(100000 + Math.random() * 900000);
}

/* ============ LOAD CHECKOUT ============ */
function loadCheckout() {
  const box = document.getElementById("checkoutBox");

  const buyNow = JSON.parse(localStorage.getItem("buyNowProduct"));
  const cart = JSON.parse(localStorage.getItem("cart")) || [];

  let total = 0;
  let html = "<h3>Order Summary</h3><hr>";

  if (buyNow) {
    total = buyNow.price * buyNow.qty;
    html += `
      <img src="${buyNow.image}" style="width:120px;">
      <p><strong>${buyNow.name}</strong></p>
      <p>‚Çπ${buyNow.price} √ó ${buyNow.qty}</p>
    `;
  } else if (cart.length > 0) {
    cart.forEach(item => {
      const itemTotal = item.price * item.qty;
      total += itemTotal;
      html += `
        <img src="${item.image}" style="width:120px;">
        <p><strong>${item.name}</strong></p>
        <p>‚Çπ${item.price} √ó ${item.qty} = ‚Çπ${itemTotal}</p>
        <hr>
      `;
    });
  } else {
    box.innerHTML = "<p>Your cart is empty.</p>";
    return;
  }

  html += `
    <h3>Total Payable: ‚Çπ${total}</h3>
    <button class="add-cart-btn" onclick="placeOrder()">Place Order</button>
    <button class="add-cart-btn" onclick="cancelOrder()" style="background:#777;margin-top:10px;">
      Cancel Order
    </button>
  `;

  box.innerHTML = html;
}

async function placeOrder() {
  const buyNow = JSON.parse(localStorage.getItem("buyNowProduct"));
  const cart = JSON.parse(localStorage.getItem("cart")) || [];

  let items = [];
  let total = 0;
  let source = "";

  if (buyNow) {
    items = [buyNow];
    total = buyNow.price * buyNow.qty;
    source = "buy_now";
  } else if (cart.length > 0) {
    items = cart;
    cart.forEach(i => total += i.price * i.qty);
    source = "cart";
  } else {
    alert("Nothing to order");
    return;
  }

  const orderData = {
    order_id: "HS-" + Math.floor(100000 + Math.random() * 900000),
    source: source,
    items: items,
    total_amount: total,
    payment_method: "COD",
    status: "Placed"
  };

  console.log("Inserting order:", orderData);

  const { error } = await supabaseClient
    .from("orders")
    .insert([orderData]);

  if (error) {
    console.error("Supabase error:", error);
    alert("Order failed: " + error.message);
    return;
  }

  alert("Order placed successfully!");

  localStorage.removeItem("buyNowProduct");
  localStorage.removeItem("cart");

  window.location.href = "index.html";
}
function cancelOrder() {
  localStorage.removeItem("buyNowProduct");
  window.history.back();
}

loadCheckout();
</script>

</body>
</html>
